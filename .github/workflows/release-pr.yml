# Publish to npm when PR is merged to production

name: Publish to npm

on:
  push:
    branches: [production]

permissions:
  contents: write
  id-token: write
  pull-requests: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v5
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - run: npm install --no-package-lock
      - run: npm run build

      - name: Generate Changelog Summary
        run: |
          echo "## ðŸ“‹ Release Changelog" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract changelogs for packages being released
          for changelog in packages/*/CHANGELOG.md packages/connectors/*/CHANGELOG.md; do
            if [ -f "$changelog" ]; then
              pkg_name=$(echo "$changelog" | sed 's|.*/\([^/]*\)/CHANGELOG.md|\1|')
              
              # Extract first entry (between first two ## headers)
              first_entry=$(awk '/^## / {if (++count == 2) exit} count == 1' "$changelog")
              
              if [ -n "$first_entry" ]; then
                echo "### ðŸ“¦ $pkg_name" >> $GITHUB_STEP_SUMMARY
                echo "$first_entry" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Publish to npm
        run: npx nx release publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}

      - name: Comment on PR with published packages
        run: |
          # Get the merge commit message to find PR number
          PR_NUMBER=$(git log -1 --pretty=%B | grep -oP 'Merge pull request #\K\d+' || echo "")

          if [ -n "$PR_NUMBER" ]; then
            # Extract published packages from git tags and format them
            PACKAGES=$(git tag --points-at HEAD | grep '@' | while read tag; do
              echo "- \`${tag//@/ v}\`"
            done)
            
            if [ -n "$PACKAGES" ]; then
              cat > /tmp/pr-comment.md << 'EOF'
          ## ðŸ“¦ Published to npm

          The following packages have been successfully published:

          EOF
              echo "$PACKAGES" >> /tmp/pr-comment.md
              cat >> /tmp/pr-comment.md << 'EOF'

          You can install them with:
          ```bash
          npm install <package-name>
          ```

          View on npm: https://www.npmjs.com/search?q=%40anygpt
          EOF
              
              gh pr comment "$PR_NUMBER" --body-file /tmp/pr-comment.md
            fi
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Sync main branch with production
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout main
          git merge origin/production --ff-only
          git push origin main
