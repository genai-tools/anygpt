version: '3.8'

services:
  ci-test:
    image: node:20-bullseye
    working_dir: /workspace
    volumes:
      - .:/workspace
      - /workspace/node_modules
    environment:
      - CI=true
      - NODE_ENV=test
    command: |
      bash -c "
        echo 'ğŸš€ Starting CI simulation...'
        echo 'ğŸ“¦ Installing dependencies...'
        npm install --legacy-peer-deps --no-package-lock
        
        echo 'ğŸ” Validating NX workspace...'
        npx nx show projects
        
        echo 'ğŸ“ Running TypeScript checks...'
        npx tsc --noEmit --project tsconfig.base.json
        
        echo 'ğŸ§ª Running tests...'
        npx nx run-many -t test || echo 'Tests failed - need to fix'
        
        echo 'ğŸ”¨ Running builds...'
        npx nx run-many -t build || echo 'Builds failed - need to fix'
        
        echo 'âœ¨ Running lints...'
        npx nx run-many -t lint || echo 'Lints failed - need to fix'
        
        echo 'âœ… CI simulation complete'
      "
